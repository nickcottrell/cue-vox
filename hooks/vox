#!/bin/bash
# cue-vox hooks - unified command interface

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$SCRIPT_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
print_header() {
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

print_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

print_error() {
    echo -e "${RED}❌ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

print_info() {
    echo -e "${BLUE}ℹ️  $1${NC}"
}

# Command: start
cmd_start() {
    print_header "Starting cue-vox server"

    # Check if server is already running
    if lsof -ti:3000 > /dev/null 2>&1; then
        print_error "Server already running on port 3000"
        print_info "Use './hooks stop' to stop it first"
        exit 1
    fi

    # Activate venv and start server
    source .venv/bin/activate
    python3 web.py
}

# Command: dev
cmd_dev() {
    print_header "Starting cue-vox in DEV mode (port 3001)"

    # Check if server is already running
    if lsof -ti:3001 > /dev/null 2>&1; then
        print_error "Server already running on port 3001"
        print_info "Use './hooks stop-dev' to stop it first"
        exit 1
    fi

    # Activate venv and start dev server
    export CUE_VOX_PORT=3001
    source .venv/bin/activate
    python3 web.py
}

# Command: stop
cmd_stop() {
    print_header "Stopping cue-vox server (port 3000)"

    if lsof -ti:3000 > /dev/null 2>&1; then
        lsof -ti:3000 | xargs kill -9
        print_success "Server stopped"
    else
        print_warning "No server running on port 3000"
    fi
}

# Command: stop-dev
cmd_stop_dev() {
    print_header "Stopping cue-vox DEV server (port 3001)"

    if lsof -ti:3001 > /dev/null 2>&1; then
        lsof -ti:3001 | xargs kill -9
        print_success "Dev server stopped"
    else
        print_warning "No server running on port 3001"
    fi
}

# Command: restart
cmd_restart() {
    print_header "Restarting cue-vox server"
    cmd_stop
    sleep 1
    cmd_start
}

# Command: status
cmd_status() {
    print_header "cue-vox server status"

    echo ""
    echo "Port 3000 (Production):"
    if lsof -ti:3000 > /dev/null 2>&1; then
        PID=$(lsof -ti:3000)
        print_success "Running (PID: $PID)"
        echo "  URL: http://localhost:3000"
    else
        print_warning "Not running"
    fi

    echo ""
    echo "Port 3001 (Dev):"
    if lsof -ti:3001 > /dev/null 2>&1; then
        PID=$(lsof -ti:3001)
        print_success "Running (PID: $PID)"
        echo "  URL: http://localhost:3001"
    else
        print_warning "Not running"
    fi

    echo ""
    echo "Logs directory:"
    if [ -d "logs" ]; then
        LOG_COUNT=$(find logs -name "*.jsonl" 2>/dev/null | wc -l | tr -d ' ')
        LOG_SIZE=$(du -sh logs 2>/dev/null | cut -f1)
        print_info "$LOG_COUNT log file(s), $LOG_SIZE total"
    else
        print_warning "No logs directory"
    fi
}

# Command: logs
cmd_logs() {
    print_header "Recent conversation logs"

    if [ ! -d "logs" ]; then
        print_warning "No logs directory found"
        exit 0
    fi

    # Get most recent log file
    LATEST_LOG=$(ls -t logs/*.jsonl 2>/dev/null | head -1)

    if [ -z "$LATEST_LOG" ]; then
        print_warning "No log files found"
        exit 0
    fi

    echo ""
    print_info "Latest log: $LATEST_LOG"
    echo ""

    # Display last 10 entries with formatting
    tail -n 10 "$LATEST_LOG" | while IFS= read -r line; do
        T_RELATIVE=$(echo "$line" | python3 -c "import sys, json; print(json.load(sys.stdin).get('t_relative', ''))" 2>/dev/null || echo "")
        T_PERIOD=$(echo "$line" | python3 -c "import sys, json; print(json.load(sys.stdin).get('t_period', ''))" 2>/dev/null || echo "")
        USER=$(echo "$line" | python3 -c "import sys, json; print(json.load(sys.stdin)['user'])" 2>/dev/null || echo "")
        ASSISTANT=$(echo "$line" | python3 -c "import sys, json; print(json.load(sys.stdin)['assistant'])" 2>/dev/null || echo "")

        if [ -n "$T_RELATIVE" ] && [ -n "$T_PERIOD" ]; then
            echo -e "${BLUE}[$T_RELATIVE - $T_PERIOD]${NC}"
        fi
        echo -e "${GREEN}User:${NC} $USER"
        echo -e "${YELLOW}Assistant:${NC} $ASSISTANT"
        echo ""
    done
}

# Command: logs-clean
cmd_logs_clean() {
    print_header "Cleaning conversation logs"

    if [ ! -d "logs" ]; then
        print_warning "No logs directory found"
        exit 0
    fi

    # Delete all log files
    LOG_COUNT=$(find logs -name "*.jsonl" 2>/dev/null | wc -l | tr -d ' ')

    if [ "$LOG_COUNT" -eq 0 ]; then
        print_warning "No log files to clean"
        exit 0
    fi

    find logs -name "*.jsonl" -delete
    print_success "Deleted $LOG_COUNT log file(s)"
}

# Command: logs-size
cmd_logs_size() {
    print_header "Log storage usage"

    if [ ! -d "logs" ]; then
        print_warning "No logs directory found"
        exit 0
    fi

    echo ""
    for logfile in logs/*.jsonl; do
        if [ -f "$logfile" ]; then
            SIZE=$(du -h "$logfile" | cut -f1)
            LINES=$(wc -l < "$logfile" | tr -d ' ')
            echo "  $(basename "$logfile"): $SIZE ($LINES conversations)"
        fi
    done
    echo ""

    TOTAL=$(du -sh logs 2>/dev/null | cut -f1)
    print_info "Total: $TOTAL"
}

# Command: install
cmd_install() {
    print_header "Installing cue-vox dependencies"

    # Create virtual environment if it doesn't exist
    if [ ! -d ".venv" ]; then
        print_info "Creating virtual environment..."
        python3 -m venv .venv
        print_success "Virtual environment created"
    fi

    # Activate and install dependencies
    source .venv/bin/activate
    print_info "Installing dependencies..."
    pip install -r requirements.txt
    print_success "Dependencies installed"
}

# Command: help
cmd_help() {
    cat << EOF
cue-vox hooks - unified command interface

USAGE:
    ./hooks <command> [options]

SERVER COMMANDS:
    start           Start production server (port 3000)
    dev             Start dev server (port 3001)
    stop            Stop production server
    stop-dev        Stop dev server
    restart         Restart production server
    status          Show server and log status

LOG COMMANDS:
    logs            Show recent conversation logs
    logs-clean      Delete all log files
    logs-size       Show log storage usage

SETUP COMMANDS:
    install         Install dependencies

EXAMPLES:
    ./hooks start               # Start server on port 3000
    ./hooks dev                 # Start dev server on port 3001
    ./hooks status              # Check what's running
    ./hooks logs                # View recent conversations
    ./hooks logs-clean          # Clear all logs

For more info, see README.md
EOF
}

# Main command dispatcher
case "${1:-}" in
    start)
        cmd_start
        ;;
    dev)
        cmd_dev
        ;;
    stop)
        cmd_stop
        ;;
    stop-dev)
        cmd_stop_dev
        ;;
    restart)
        cmd_restart
        ;;
    status)
        cmd_status
        ;;
    logs)
        cmd_logs
        ;;
    logs-clean)
        cmd_logs_clean
        ;;
    logs-size)
        cmd_logs_size
        ;;
    install)
        cmd_install
        ;;
    help|--help|-h|"")
        cmd_help
        ;;
    *)
        print_error "Unknown command: $1"
        echo ""
        cmd_help
        exit 1
        ;;
esac
