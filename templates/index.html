<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cue-vox</title>

    <!-- Haberdash CSS (base components + default tokens) -->
    <link rel="stylesheet" href="https://nickcottrell.github.io/haberdash/haberdash.css">

    <!-- Dynamic VRGB tokens (injected by Spectra) -->
    <style id="vrgb-tokens">/* Tokens will be injected here by JavaScript */</style>

    <!-- VRGB Theme (static fallback) -->
    <link rel="stylesheet" href="/static/css/cue-vox-theme.css">

    <!-- Layout/Structure (cue-vox-specific) -->
    <link rel="stylesheet" href="/static/css/style.css">

    <!-- Spectra Theme Loader -->
    <script>
        const THEME_NODE_ID = 'haberdash-ui-theme';
        const API_BASE = 'https://zf8klzvd4k.execute-api.us-east-2.amazonaws.com/prod';

        async function loadTheme() {
            try {
                const nodeResponse = await fetch(`${API_BASE}/api/node?node_id=${THEME_NODE_ID}`);
                const nodeData = await nodeResponse.json();

                if (nodeData.unstyled || !nodeData.vrgb) {
                    console.log('Using default unstyled theme');
                    return;
                }

                if (nodeData.vrgb) {
                    const params = new URLSearchParams({
                        d1_hsl: nodeData.vrgb.d1_hsl.join(','),
                        d2_lab: nodeData.vrgb.d2_lab.join(','),
                        d3_lab: nodeData.vrgb.d3_lab.join(','),
                        d4_lab: nodeData.vrgb.d4_lab.join(',')
                    });

                    const generateResponse = await fetch(`${API_BASE}/api/generate?${params}`);
                    const generateData = await generateResponse.json();

                    if (generateData.tokens) {
                        const cssRules = generateData.tokens.__css_rules__ || '';
                        const tokenCSS = Object.entries(generateData.tokens)
                            .filter(([k]) => k !== '__css_rules__')
                            .map(([k, v]) => `${k}: ${v};`)
                            .join(' ');
                        const finalCSS = `:root { ${tokenCSS} }\n\n${cssRules}`;
                        document.getElementById('vrgb-tokens').textContent = finalCSS;
                        console.log('âœ“ Loaded Spectra theme');
                    }
                }
            } catch (error) {
                console.log('Using static fallback theme:', error);
            }
        }

        loadTheme();
    </script>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <!-- Drawer Toggle -->
    <button class="drawer-toggle" id="drawerToggle" aria-label="Toggle conversation">
        ðŸ’¬
    </button>

    <!-- Drawer Panel -->
    <aside class="drawer" id="drawer">
        <!-- Conversation Area -->
        <div class="conversation" id="conversation" role="log" aria-live="polite">
            <!-- Messages render here as cards -->
        </div>

        <!-- Status Indicator -->
        <div class="drawer-status">
            <span class="status-dot" id="drawerStatusDot" data-state="idle"></span>
            <span class="status-text" id="drawerStatusText">idle</span>
            <a href="#" class="drawer-status__stop-link" id="drawerStopLink" style="display: none;">stop audio</a>
        </div>

        <!-- Text Input -->
        <div class="drawer-input">
            <textarea class="form__input" id="drawerTextInput" placeholder="Type a message..." rows="1"></textarea>
            <button class="btn btn--primary" id="drawerSendButton">Send</button>
        </div>
    </aside>

    <!-- Main Canvas -->
    <main class="canvas">
        <!-- Session Label -->
        <h1 class="canvas__title" id="sessionTitle">
            cue-vox
        </h1>

        <!-- State Indicator Dot -->
        <div class="state-dot" id="stateDot" role="status" aria-label="System state">
            <div class="state-dot__inner" data-state="idle"></div>
        </div>

        <!-- Stop Audio Button (only visible when speaking) -->
        <button class="btn btn--secondary canvas__stop-btn" id="canvasStopBtn" style="display: none;">
            Stop Audio
        </button>

        <!-- Status Text -->
        <p class="canvas__status" id="canvasStatus" aria-live="polite">
            idle
        </p>

        <!-- Instructions -->
        <p class="canvas__instructions">
            Hold SPACE to talk â€¢ Release to process â€¢ Press SPACE mid-response to interrupt
        </p>
    </main>

    <!-- Application Script -->
    <script src="/static/js/app.js"></script>
</body>
</html>
